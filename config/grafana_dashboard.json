{
  "overwrite": true,
  "dashboard": {
    "id": null,
    "uid": "email-ingestion",
    "title": "Email Ingestion Overview",
    "timezone": "browser",
    "schemaVersion": 39,
    "version": 1,
    "panels": [
      {
        "type": "timeseries",
        "title": "Emails Produced vs Processed",
        "gridPos": { "x": 0, "y": 0, "w": 12, "h": 8 },
        "datasource": { "type": "prometheus", "uid": "PROMETHEUS_DS" },
        "targets": [
          { "expr": "rate(email_ingestion_emails_produced_total[5m])", "legendFormat": "produced" },
          { "expr": "rate(email_ingestion_emails_processed_total[5m])", "legendFormat": "processed" }
        ]
      },
      {
        "type": "timeseries",
        "title": "Processing Errors & DLQ",
        "gridPos": { "x": 12, "y": 0, "w": 12, "h": 8 },
        "datasource": { "type": "prometheus", "uid": "PROMETHEUS_DS" },
        "targets": [
          { "expr": "rate(email_ingestion_emails_failed_total[5m])", "legendFormat": "failed" },
          { "expr": "rate(email_ingestion_dlq_messages_total[5m])", "legendFormat": "dlq" }
        ]
      },
      {
        "type": "timeseries",
        "title": "Processing Latency (p50/p90/p99)",
        "gridPos": { "x": 0, "y": 8, "w": 12, "h": 8 },
        "datasource": { "type": "prometheus", "uid": "PROMETHEUS_DS" },
        "targets": [
          { "expr": "histogram_quantile(0.5, rate(email_ingestion_processing_latency_seconds_bucket[5m]))", "legendFormat": "p50" },
          { "expr": "histogram_quantile(0.9, rate(email_ingestion_processing_latency_seconds_bucket[5m]))", "legendFormat": "p90" },
          { "expr": "histogram_quantile(0.99, rate(email_ingestion_processing_latency_seconds_bucket[5m]))", "legendFormat": "p99" }
        ]
      },
      {
        "type": "timeseries",
        "title": "Queue Depth & IMAP Poll Duration",
        "gridPos": { "x": 12, "y": 8, "w": 12, "h": 8 },
        "datasource": { "type": "prometheus", "uid": "PROMETHEUS_DS" },
        "targets": [
          { "expr": "email_ingestion_stream_depth", "legendFormat": "stream depth" },
          { "expr": "rate(email_ingestion_imap_poll_duration_seconds_sum[5m]) / rate(email_ingestion_imap_poll_duration_seconds_count[5m])", "legendFormat": "poll avg (s)" }
        ]
      },
      {
        "type": "stat",
        "title": "Backoff Retries",
        "gridPos": { "x": 0, "y": 16, "w": 6, "h": 6 },
        "datasource": { "type": "prometheus", "uid": "PROMETHEUS_DS" },
        "targets": [
          { "expr": "increase(email_ingestion_backoff_retries_total[1h])", "legendFormat": "retries" }
        ],
        "options": { "reduceOptions": { "calcs": ["last"] } }
      },
      {
        "type": "stat",
        "title": "Health Status",
        "gridPos": { "x": 6, "y": 16, "w": 6, "h": 6 },
        "datasource": { "type": "prometheus", "uid": "PROMETHEUS_DS" },
        "targets": [
          { "expr": "probe_success{job=\"email_ingestion_health\"}", "legendFormat": "health" }
        ],
        "options": { "reduceOptions": { "calcs": ["last"] } }
      }
    ],
    "templating": {
      "list": []
    }
  }
}
